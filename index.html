
<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é€šç”¨å‹ API è³‡æ–™è½‰æ›å™¨ V2.1 (é™¤éŒ¯ç‰ˆ)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        .hidden { display: none !important; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; line-height: 1.6; color: #333; max-width: 1400px; margin: 0 auto; padding: 20px; background-color: #f4f7f6; }

        .header-container { text-align: center; margin-bottom: 20px; }
        h1 { color: #2c3e50; margin: 0; }
        
        #api-input-area { background: white; padding: 25px; border-radius: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); display: flex; flex-direction: column; gap: 15px; margin-bottom: 25px; border: 1px solid #e1e4e8; }
        .input-group { display: flex; gap: 10px; width: 100%; }
        #api-url { flex: 1; padding: 12px; border: 2px solid #ddd; border-radius: 6px; font-size: 16px; outline: none; font-family: monospace; }
        #api-url:focus { border-color: #3498db; }
        
        #fetch-btn { padding: 10px 30px; font-size: 16px; color: #fff; background-color: #0366d6; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; white-space: nowrap; }
        #fetch-btn:hover { background-color: #0255b3; }
        #fetch-btn:disabled { background-color: #ccc; cursor: wait; }

        .status-bar { font-size: 0.9em; color: #666; display: flex; align-items: center; gap: 10px; background: #f8f9fa; padding: 10px; border-radius: 5px; border: 1px solid #eee;}
        .proxy-badge { background: #3498db; color: white; padding: 2px 8px; border-radius: 4px; font-size: 0.85em; }

        /* éŒ¯èª¤èˆ‡é™¤éŒ¯å€ */
        #error-box { background: #fee; color: #c00; padding: 15px; border-radius: 5px; border: 1px solid #fcc; margin-top: 10px; white-space: pre-wrap; }
        #debug-box { background: #2d2d2d; color: #f8f8f2; padding: 15px; border-radius: 5px; margin-top: 10px; font-family: monospace; overflow-x: auto; max-height: 300px; font-size: 0.9em; border: 1px solid #444; }
        .debug-title { color: #ff79c6; font-weight: bold; margin-bottom: 5px; display: block; }

        /* å…§å®¹å€å¡Š */
        .content-box { background-color: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .table-actions-container { display: flex; flex-wrap: wrap; gap: 15px; margin: 20px 0; align-items: center; justify-content: space-between; }
        
        .search-box { display: flex; gap: 10px; flex: 1; min-width: 300px; }
        #table-search-input { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; }
        
        .export-buttons-group button { padding: 8px 15px; font-size: 0.9em; color: #fff; border: none; border-radius: 4px; cursor: pointer; transition: opacity 0.2s; margin-right: 5px; }
        .export-buttons-group button:hover { opacity: 0.9; }
        .export-buttons-group button:disabled { background-color: #ccc !important; cursor: not-allowed; }

        #export-excel-btn { background-color: #217346; }
        #export-csv-btn { background-color: #f39c12; }
        #export-json-btn { background-color: #5b62f4; }

        /* è¡¨æ ¼ */
        .table-wrapper { overflow-x: auto; border: 1px solid #eee; border-radius: 5px; max-height: 70vh; }
        table { width: 100%; border-collapse: collapse; min-width: 800px; font-size: 14px; }
        th, td { padding: 10px 12px; text-align: left; border-bottom: 1px solid #ddd; vertical-align: top; max-width: 300px; word-wrap: break-word; }
        th { background-color: #f8f9fa; position: sticky; top: 0; z-index: 10; white-space: nowrap; }
        
        /* è®€å–å‹•ç•« */
        #loader { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255, 255, 255, 0.8); z-index: 9999; display: flex; justify-content: center; align-items: center; flex-direction: column; }
        .spinner { border: 5px solid #f3f3f3; border-top: 5px solid #3498db; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div id="loader" class="hidden">
        <div class="spinner"></div>
        <p style="margin-top:10px; font-weight:bold;">è³‡æ–™åµæ¢å·¥ä½œä¸­...</p>
    </div>

    <div class="header-container">
        <h1>ğŸ”— é€šç”¨å‹ API è³‡æ–™è½‰æ›å™¨ V2.1 (é™¤éŒ¯ç‰ˆ)</h1>
        <p>å…§å»º JSON çµæ§‹é€è¦–åŠŸèƒ½ï¼Œæ‰¾å‡ºè³‡æ–™éš±è—åœ¨å“ªè£¡</p>
    </div>
    
    <div id="api-input-area">
        <div class="input-group">
            <input type="text" id="api-url" placeholder="è«‹è²¼ä¸Š API ç¶²å€..." value="https://data.food.gov.uk/food-alerts/id/alerts.json?_limit=10">
            <button id="fetch-btn">ğŸ” æŠ“å–ä¸¦åˆ†æ</button>
        </div>
        
        <div class="status-bar">
            <span>é€£ç·šç‹€æ…‹:</span>
            <span id="connection-status" style="color:#666;">æº–å‚™å°±ç·’</span>
        </div>
        
        <div id="error-box" class="hidden"></div>
        <div id="debug-box" class="hidden"></div>
    </div>

    <div id="main-content" class="hidden">
        <div class="content-box">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h2>è³‡æ–™é è¦½ <span id="data-count-badge" style="font-size:0.7em; background:#eee; padding:2px 6px; border-radius:10px;"></span></h2>
                <button onclick="resetApp()" style="padding:5px 10px; font-size:0.8em; cursor:pointer;">é‡ç½®</button>
            </div>

            <div class="table-actions-container">
                <div class="search-box">
                    <input type="text" id="table-search-input" placeholder="åœ¨çµæœä¸­æœå°‹...">
                </div>
                <div class="export-buttons-group">
                    <button id="export-excel-btn">åŒ¯å‡º Excel</button>
                    <button id="export-csv-btn">åŒ¯å‡º CSV</button>
                    <button id="export-json-btn">åŒ¯å‡º JSON</button>
                </div>
            </div>

            <div class="table-wrapper">
                <div id="table-container"></div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const loader = document.getElementById('loader');
            const mainContent = document.getElementById('main-content');
            const errorBox = document.getElementById('error-box');
            const debugBox = document.getElementById('debug-box');
            const tableContainer = document.getElementById('table-container');
            const apiUrlInput = document.getElementById('api-url');
            const statusText = document.getElementById('connection-status');
            const fetchBtn = document.getElementById('fetch-btn');
            
            let originalData = [];
            let currentViewData = [];
            let headers = [];

            // Proxy åˆ—è¡¨
            const PROXY_LIST = [
                { name: "CORSProxy.io", prefix: "https://corsproxy.io/?" },
                { name: "AllOrigins", prefix: "https://api.allorigins.win/raw?url=" },
                { name: "Direct", prefix: "" }
            ];

            fetchBtn.addEventListener('click', () => startSmartFetch());
            apiUrlInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') startSmartFetch(); });

            async function startSmartFetch() {
                let url = apiUrlInput.value.trim();
                if (!url) return alert("è«‹è¼¸å…¥ç¶²å€");
                
                showLoader(true);
                errorBox.classList.add('hidden');
                debugBox.classList.add('hidden');
                mainContent.classList.add('hidden');
                fetchBtn.disabled = true;

                let success = false;

                for (let proxy of PROXY_LIST) {
                    updateStatus(`å˜—è©¦é€šé“: <span class="proxy-badge">${proxy.name}</span>`, "black");
                    
                    try {
                        let targetUrl = proxy.prefix ? proxy.prefix + encodeURIComponent(url) : url;
                        const response = await fetch(targetUrl);
                        
                        if (!response.ok) {
                            console.warn(`${proxy.name} status: ${response.status}`);
                            continue; 
                        }

                        // å˜—è©¦è§£æ JSON
                        const textData = await response.text();
                        let rawData;
                        try {
                            rawData = JSON.parse(textData);
                        } catch (e) {
                            throw new Error("å›å‚³çš„ä¸æ˜¯ JSON æ ¼å¼ (å¯èƒ½æ˜¯ HTML éŒ¯èª¤é é¢)");
                        }
                        
                        // æˆåŠŸï¼
                        processSuccess(rawData, proxy.name);
                        success = true;
                        break; 

                    } catch (e) {
                        console.warn(`${proxy.name} error:`, e);
                    }
                }

                if (!success) {
                    updateStatus("æ‰€æœ‰é€šé“å¤±æ•—", "red");
                    showError("é€£ç·šå¤±æ•—ã€‚è«‹æª¢æŸ¥ç¶²å€æ˜¯å¦æ­£ç¢ºï¼Œæˆ–ç›®æ¨™ä¼ºæœå™¨æ‹’çµ•é€£ç·šã€‚");
                }
                
                showLoader(false);
                fetchBtn.disabled = false;
            }

            function processSuccess(rawData, proxyName) {
                updateStatus(`é€£ç·šæˆåŠŸ (é€šé“: ${proxyName})`, "green");
                
                // é¡¯ç¤ºé™¤éŒ¯è³‡è¨Šï¼šè®“ä½¿ç”¨è€…çœ‹åˆ° API å›å‚³äº†ä»€éº¼ Key
                showDebugInfo(rawData);

                // å°‹æ‰¾è³‡æ–™é™£åˆ—
                let dataArray = findDataArray(rawData);
                
                if (!dataArray) {
                    showError("é€£ç·šæˆåŠŸï¼Œä½†ç„¡æ³•è‡ªå‹•è­˜åˆ¥è³‡æ–™åˆ—è¡¨ã€‚\nè«‹æŸ¥çœ‹ä¸‹æ–¹çš„ã€Œå›æ‡‰çµæ§‹é€è¦–ã€ä»¥ç¢ºèª API å›å‚³æ ¼å¼ã€‚");
                    return;
                }

                if (dataArray.length === 0) {
                    // ä¿®æ­£ï¼šç©ºé™£åˆ—ä¸æ˜¯éŒ¯èª¤ï¼Œåªæ˜¯æ²’è³‡æ–™
                    updateStatus(`é€£ç·šæˆåŠŸï¼Œä½†æŸ¥è©¢çµæœç‚º 0 ç­†`, "#e67e22");
                    originalData = [];
                    initTable();
                    mainContent.classList.remove('hidden');
                    return;
                }

                // æ‰å¹³åŒ–
                originalData = dataArray.map(item => flattenObject(item));
                initTable();
                mainContent.classList.remove('hidden');
            }

            function showDebugInfo(data) {
                debugBox.classList.remove('hidden');
                let debugText = "<span class='debug-title'>ğŸ•µï¸ å›æ‡‰çµæ§‹é€è¦– (Top Level Keys):</span>";
                
                if (Array.isArray(data)) {
                    debugText += `[Array] (Length: ${data.length})`;
                    if(data.length > 0) debugText += `\nSample keys: ${Object.keys(data[0]).join(', ')}`;
                } else if (typeof data === 'object') {
                    debugText += JSON.stringify(Object.keys(data), null, 2);
                    // ç‰¹åˆ¥é‡å° FSA é¡¯ç¤º items
                    if(data.items) {
                         debugText += `\n\nFound 'items': ${Array.isArray(data.items) ? `Array(${data.items.length})` : typeof data.items}`;
                    }
                } else {
                    debugText += String(data);
                }
                debugBox.innerHTML = debugText;
            }

            function findDataArray(obj) {
                if (Array.isArray(obj)) return obj;
                // å¸¸è¦‹çš„ API åŒ…è£ Key
                const keys = ['items', 'results', 'data', 'records', 'rows', 'list'];
                for (let k of keys) {
                    if (obj[k] && Array.isArray(obj[k])) return obj[k];
                }
                // æš´åŠ›æœå°‹ç¬¬ä¸€å€‹æ˜¯é™£åˆ—çš„ Key
                for (let key in obj) {
                    if (Array.isArray(obj[key])) return obj[key];
                }
                return null;
            }

            function flattenObject(obj, prefix = '', result = {}) {
                for (const key in obj) {
                    const newKey = prefix ? `${prefix}.${key}` : key;
                    const value = obj[key];
                    if (value && typeof value === 'object' && !Array.isArray(value)) {
                        flattenObject(value, newKey, result);
                    } else if (Array.isArray(value)) {
                         result[newKey] = value.map(v => typeof v === 'object' ? JSON.stringify(v) : v).join("; ");
                    } else {
                        result[newKey] = value;
                    }
                }
                return result;
            }

            function initTable() {
                if (originalData.length === 0) {
                    document.getElementById('data-count-badge').textContent = "0 ç­†";
                    renderTable();
                    return;
                }
                let keySet = new Set();
                originalData.slice(0, 50).forEach(row => Object.keys(row).forEach(k => keySet.add(k)));
                headers = Array.from(keySet).sort();
                document.getElementById('data-count-badge').textContent = `${originalData.length} ç­†`;
                currentViewData = originalData;
                renderTable();
            }

            function renderTable() {
                tableContainer.innerHTML = "";
                if (!currentViewData || currentViewData.length === 0) {
                    tableContainer.innerHTML = "<div style='text-align:center; padding:40px; color:#888;'>ğŸ“­ æŸ¥ç„¡è³‡æ–™<br><small>è«‹å˜—è©¦æ”¾å¯¬æœå°‹æ¢ä»¶</small></div>";
                    return;
                }

                const table = document.createElement('table');
                const thead = table.createTHead();
                const tr = thead.insertRow();
                headers.forEach(h => {
                    let th = document.createElement('th');
                    th.textContent = h;
                    tr.appendChild(th);
                });

                const tbody = table.createTBody();
                currentViewData.slice(0, 100).forEach(row => {
                    let tr = tbody.insertRow();
                    headers.forEach(h => {
                        let td = tr.insertCell();
                        let val = row[h] !== undefined ? String(row[h]) : "";
                        if (val.length > 100) {
                            td.title = val;
                            val = val.substring(0, 100) + "...";
                        }
                        td.textContent = val;
                    });
                });
                tableContainer.appendChild(table);
            }

            // äº‹ä»¶ç¶å®š
            document.getElementById('table-search-input').addEventListener('input', (e) => {
                const term = e.target.value.toLowerCase();
                currentViewData = originalData.filter(row => Object.values(row).some(v => String(v).toLowerCase().includes(term)));
                renderTable();
            });
            
            document.getElementById('export-excel-btn').addEventListener('click', () => {
                if(originalData.length===0) return;
                const ws = XLSX.utils.json_to_sheet(currentViewData);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Data");
                XLSX.writeFile(wb, `export_data.xlsx`);
            });
            
            function updateStatus(html, color) { statusText.innerHTML = html; statusText.style.color = color; }
            function showLoader(show) { show ? loader.classList.remove('hidden') : loader.classList.add('hidden'); }
            function showError(msg) { errorBox.textContent = msg; errorBox.classList.remove('hidden'); }
            window.resetApp = function() { location.reload(); }
        });
    </script>
</body>
</html>
