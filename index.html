<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é€šç”¨å‹ API to Excel/CSV è½‰æ›å™¨</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        .hidden { display: none !important; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            line-height: 1.6; color: #333; max-width: 1400px;
            margin: 0 auto; padding: 20px; background-color: #f4f7f6;
        }

        /* æ¨™é¡Œå€ */
        .header-container { text-align: center; margin-bottom: 20px; }
        h1 { color: #2c3e50; margin: 0; }
        p { color: #666; margin-top: 5px; }
        
        /* API è¼¸å…¥æ§åˆ¶å€ */
        #api-input-area {
            background: white; padding: 25px; border-radius: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            display: flex; flex-direction: column; gap: 15px; margin-bottom: 25px; border: 1px solid #e1e4e8;
        }

        .input-group { display: flex; gap: 10px; width: 100%; }
        #api-url { 
            flex: 1; padding: 12px; border: 2px solid #ddd; border-radius: 6px; font-size: 16px; outline: none; transition: border-color 0.3s;
        }
        #api-url:focus { border-color: #3498db; }
        
        #fetch-btn {
            padding: 10px 30px; font-size: 16px; color: #fff; background-color: #0366d6; 
            border: none; border-radius: 6px; cursor: pointer; transition: background 0.3s; font-weight: bold; white-space: nowrap;
        }
        #fetch-btn:hover { background-color: #0255b3; }
        #fetch-btn:disabled { background-color: #ccc; cursor: not-allowed; }

        .options-group { display: flex; align-items: center; gap: 20px; font-size: 14px; color: #555; }
        .checkbox-label { display: flex; align-items: center; gap: 5px; cursor: pointer; }
        
        /* éŒ¯èª¤è¨Šæ¯ */
        #error-box { background: #fee; color: #c00; padding: 10px; border-radius: 5px; border: 1px solid #fcc; margin-top: 10px; }

        /* è®€å–å‹•ç•« */
        #loader { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255, 255, 255, 0.9); z-index: 9999; display: flex; justify-content: center; align-items: center; flex-direction: column; gap: 20px; }
        .spinner { border: 6px solid #f3f3f3; border-top: 6px solid #3498db; border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* å…§å®¹å€å¡Š */
        .content-box { background-color: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); margin-bottom: 20px; }
        h2 { color: #2c3e50; border-bottom: 2px solid #e0e0e0; padding-bottom: 10px; margin-top: 0; font-size: 1.2em; }

        /* ç¯©é¸å™¨æ¨£å¼ */
        #filter-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 15px; }
        .filter-control label { display: block; margin-bottom: 5px; font-weight: bold; font-size: 0.85em; color: #666; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .filter-control select { width: 100%; padding: 8px; border-radius: 4px; border: 1px solid #bdc3c7; background: #f9f9f9; }

        /* è¡¨æ ¼èˆ‡æ“ä½œå€ */
        .table-actions-container { display: flex; flex-wrap: wrap; gap: 15px; margin: 20px 0; align-items: center; justify-content: space-between; }
        .search-box { display: flex; gap: 10px; flex: 1; min-width: 300px; }
        #table-search-input { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; }
        
        .export-buttons-group { display: flex; gap: 8px; flex-wrap: wrap; }
        .export-buttons-group button {
            padding: 8px 15px; font-size: 0.9em; color: #fff; border: none; border-radius: 4px; 
            cursor: pointer; transition: opacity 0.2s;
        }
        .export-buttons-group button:hover { opacity: 0.9; }
        .export-buttons-group button:disabled { background-color: #ccc !important; cursor: not-allowed; }

        #export-excel-btn { background-color: #217346; }
        #export-csv-btn { background-color: #f39c12; }
        #export-json-btn { background-color: #5b62f4; }
        #export-xml-btn { background-color: #8e44ad; }

        /* è¡¨æ ¼æœ¬é«” */
        .table-wrapper { overflow-x: auto; border: 1px solid #eee; border-radius: 5px; max-height: 70vh; }
        table { width: 100%; border-collapse: collapse; min-width: 800px; font-size: 14px; }
        th, td { padding: 10px 12px; text-align: left; border-bottom: 1px solid #ddd; vertical-align: top; max-width: 300px; word-wrap: break-word; }
        th { background-color: #f8f9fa; font-weight: 600; color: #333; position: sticky; top: 0; z-index: 10; border-bottom: 2px solid #ddd; white-space: nowrap; }
        tr:hover { background-color: #f1f1f1; }
        th.sortable { cursor: pointer; user-select: none; }
        th.sort-asc::after { content: ' â–²'; color: #007bff; }
        th.sort-desc::after { content: ' â–¼'; color: #007bff; }
    </style>
</head>
<body>

    <div id="loader" class="hidden">
        <div class="spinner"></div>
        <p>è³‡æ–™è™•ç†ä¸­ï¼Œè«‹ç¨å€™...</p>
    </div>

    <div class="header-container">
        <h1>ğŸ”— é€šç”¨å‹ API è³‡æ–™è½‰æ›å™¨</h1>
        <p>è²¼ä¸Šä»»ä¸€å›å‚³ JSON çš„ç¶²å€ï¼Œè‡ªå‹•è½‰ç‚ºå¯ç¯©é¸è¡¨æ ¼ä¸¦åŒ¯å‡º</p>
    </div>
    
    <div id="api-input-area">
        <div class="input-group">
            <input type="text" id="api-url" placeholder="è«‹è²¼ä¸Š API ç¶²å€ (ä¾‹å¦‚: https://api.fda.gov/food/enforcement.json?limit=10)">
            <button id="fetch-btn">æŠ“å–è³‡æ–™</button>
        </div>
        <div class="options-group">
            <label class="checkbox-label" title="è‹¥é‡åˆ°è·¨åŸŸ(CORS)éŒ¯èª¤ï¼Œè«‹å‹¾é¸æ­¤é …å˜—è©¦ç¹é">
                <input type="checkbox" id="cors-proxy"> 
                ä½¿ç”¨ CORS Proxy (è§£æ±ºè·¨åŸŸè¢«æ“‹å•é¡Œ)
            </label>
            <span style="color:#999; font-size:0.9em;">(æç¤ºï¼šè‹¥æŠ“ä¸åˆ°è³‡æ–™ï¼Œè«‹å‹¾é¸ Proxy å†è©¦ä¸€æ¬¡)</span>
        </div>
        <div id="error-box" class="hidden"></div>
    </div>

    <div id="main-content" class="hidden">
        
        <div class="content-box">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                <h2>æ¬„ä½ç¯©é¸å™¨</h2>
                <button onclick="resetFilters()" style="font-size:0.85em; padding:5px 10px; cursor:pointer;">é‡ç½®ç¯©é¸</button>
            </div>
            <div id="filter-container"></div>
        </div>

        <div class="content-box">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h2>è³‡æ–™é è¦½</h2>
                <span id="data-stats" style="font-size:0.9em; color:#666;"></span>
            </div>

            <div class="table-actions-container">
                <div class="search-box">
                    <input type="text" id="table-search-input" placeholder="æœå°‹é—œéµå­—...">
                </div>
                <div class="export-buttons-group">
                    <button id="export-excel-btn">Excel</button>
                    <button id="export-csv-btn">CSV</button>
                    <button id="export-json-btn">JSON</button>
                    <button id="export-xml-btn">XML</button>
                </div>
            </div>

            <div class="table-wrapper">
                <div id="table-container"></div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // DOM å…ƒç´ 
            const loader = document.getElementById('loader');
            const mainContent = document.getElementById('main-content');
            const errorBox = document.getElementById('error-box');
            const filterContainer = document.getElementById('filter-container');
            const tableContainer = document.getElementById('table-container');
            const tableSearchInput = document.getElementById('table-search-input');
            const dataStats = document.getElementById('data-stats');
            const apiUrlInput = document.getElementById('api-url');
            const corsProxyCheckbox = document.getElementById('cors-proxy');
            
            // æŒ‰éˆ•
            const fetchBtn = document.getElementById('fetch-btn');
            const exportBtns = {
                excel: document.getElementById('export-excel-btn'),
                csv: document.getElementById('export-csv-btn'),
                json: document.getElementById('export-json-btn'),
                xml: document.getElementById('export-xml-btn')
            };

            // ç‹€æ…‹è®Šæ•¸
            let originalData = [];
            let currentViewData = [];
            let headers = [];
            let sortState = { column: null, direction: 'none' };

            // 1. ç¶å®šæŒ‰éˆ•äº‹ä»¶
            fetchBtn.addEventListener('click', () => {
                const url = apiUrlInput.value.trim();
                if (!url) {
                    showError("è«‹è¼¸å…¥æœ‰æ•ˆçš„ç¶²å€ï¼");
                    return;
                }
                fetchApiData(url);
            });

            // æŒ‰ä¸‹ Enter ä¹Ÿå¯ä»¥æœå°‹
            apiUrlInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') fetchBtn.click();
            });

            // 2. æ ¸å¿ƒ Fetch é‚è¼¯
            async function fetchApiData(url) {
                showLoader(true);
                showError(null); // æ¸…é™¤éŒ¯èª¤
                mainContent.classList.add('hidden');

                // è™•ç† CORS Proxy
                let targetUrl = url;
                if (corsProxyCheckbox.checked) {
                    // ä½¿ç”¨ AllOrigins ä½œç‚º Proxy
                    targetUrl = `https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`;
                }

                try {
                    const response = await fetch(targetUrl);
                    if (!response.ok) throw new Error(`é€£ç·šå¤±æ•— (HTTP ${response.status})`);
                    
                    const rawData = await response.json();
                    
                    // 3. æ™ºæ…§è§£æï¼šå°‹æ‰¾ JSON ä¸­çœŸæ­£çš„ã€Œè³‡æ–™é™£åˆ—ã€
                    const dataArray = findDataArray(rawData);

                    if (!dataArray || dataArray.length === 0) {
                        throw new Error("æˆåŠŸé€£ç·šï¼Œä½†åœ¨å›æ‡‰ä¸­æ‰¾ä¸åˆ°é™£åˆ—æ ¼å¼çš„è³‡æ–™ã€‚è«‹ç¢ºèªè©² API æ˜¯å¦å›å‚³åˆ—è¡¨è³‡æ–™ã€‚");
                    }

                    // 4. è³‡æ–™æ‰å¹³åŒ–è™•ç† (è®“å·¢ç‹€ç‰©ä»¶è®Šæˆå¯é¡¯ç¤ºçš„å–®å±¤æ¬„ä½)
                    originalData = dataArray.map(item => flattenObject(item));
                    
                    // åˆå§‹åŒ–è¡¨æ ¼
                    initTableUI();

                } catch (error) {
                    console.error(error);
                    let msg = error.message;
                    if (msg.includes("Failed to fetch")) {
                        msg = "é€£ç·šè¢«æ‹’çµ•ã€‚é€™é€šå¸¸æ˜¯å› ç‚ºè·¨åŸŸ(CORS)é™åˆ¶ã€‚<br>è«‹å˜—è©¦å‹¾é¸ä¸Šæ–¹çš„ <b>ã€Œä½¿ç”¨ CORS Proxyã€</b> é¸é …å†è©¦ä¸€æ¬¡ã€‚";
                    }
                    showError(msg);
                } finally {
                    showLoader(false);
                }
            }

            // --- è¼”åŠ©é‚è¼¯ï¼šæ™ºæ…§å°‹æ‰¾é™£åˆ— ---
            function findDataArray(obj) {
                if (Array.isArray(obj)) return obj;
                if (typeof obj !== 'object' || obj === null) return null;

                // å¸¸è¦‹çš„ API æ¬„ä½åç¨±å„ªå…ˆç´š
                const commonKeys = ['results', 'data', 'items', 'records', 'rows', 'list'];
                for (const key of commonKeys) {
                    if (Array.isArray(obj[key])) return obj[key];
                }

                // è‹¥æ²’å°ä¸­å¸¸è¦‹åç¨±ï¼Œå‰‡æœå°‹ç¬¬ä¸€å€‹æ˜¯é™£åˆ—çš„ value
                for (const key in obj) {
                    if (Array.isArray(obj[key])) return obj[key];
                }
                
                return null;
            }

            // --- è¼”åŠ©é‚è¼¯ï¼šç‰©ä»¶æ‰å¹³åŒ– (ç°¡å–®ç‰ˆ) ---
            // å°‡ { user: { name: "A", id: 1 } } è½‰ç‚º { "user.name": "A", "user.id": 1 }
            function flattenObject(obj, prefix = '', result = {}) {
                for (const key in obj) {
                    if (obj.hasOwnProperty(key)) {
                        const newKey = prefix ? `${prefix}.${key}` : key;
                        const value = obj[key];

                        if (value && typeof value === 'object' && !Array.isArray(value)) {
                            flattenObject(value, newKey, result);
                        } else if (Array.isArray(value)) {
                            // é™£åˆ—ç›´æ¥è½‰å­—ä¸²é¡¯ç¤ºï¼Œä¸æ·±åº¦å±•é–‹ä»¥å…è¡¨æ ¼å¤ªäº‚
                            result[newKey] = JSON.stringify(value);
                        } else {
                            result[newKey] = value;
                        }
                    }
                }
                return result;
            }

            // --- UI åˆå§‹åŒ– ---
            function initTableUI() {
                if (originalData.length === 0) return;

                // åµæ¸¬æ‰€æœ‰æ¬„ä½
                const keySet = new Set();
                // æƒæå‰ 20 ç­†è³‡æ–™ä¾†æ”¶é›†æ‰€æœ‰å¯èƒ½çš„æ¬„ä½
                originalData.slice(0, 20).forEach(row => {
                    Object.keys(row).forEach(k => keySet.add(k));
                });
                headers = Array.from(keySet).sort();

                renderFilters();
                updateView();
                mainContent.classList.remove('hidden');
            }

            // --- æ¸²æŸ“ç¯©é¸å™¨ ---
            function renderFilters() {
                filterContainer.innerHTML = '';
                
                // ç‚ºäº†é¿å…æ¬„ä½å¤ªå¤šç¯©é¸å™¨çˆ†ç‚¸ï¼Œåªé¸å–ã€Œé‡è¤‡å€¼è¼ƒå¤šã€çš„æ¬„ä½ç•¶ç¯©é¸å™¨
                // é‚è¼¯ï¼šå¦‚æœä¸€å€‹æ¬„ä½çš„å”¯ä¸€å€¼æ•¸é‡ < è³‡æ–™ç¸½æ•¸çš„ 20%ï¼Œå‰‡é©åˆç•¶åˆ†é¡ç¯©é¸
                const suitableFilters = headers.filter(header => {
                    const uniqueCount = new Set(originalData.map(item => item[header])).size;
                    return uniqueCount > 1 && uniqueCount < 50 && uniqueCount < originalData.length * 0.5;
                });

                if (suitableFilters.length === 0) {
                     filterContainer.innerHTML = '<p style="color:#888; grid-column: 1/-1;">è‡ªå‹•åµæ¸¬ï¼šç„¡é©åˆå»ºç«‹ä¸‹æ‹‰é¸å–®çš„åˆ†é¡æ¬„ä½ (æ‰€æœ‰æ¬„ä½å€¼å·®ç•°éå¤§)ã€‚</p>';
                }

                suitableFilters.forEach(header => {
                    const uniqueValues = [...new Set(originalData.map(item => item[header]))]
                        .filter(v => v != null && v !== "")
                        .sort();

                    const control = document.createElement('div');
                    control.className = 'filter-control';
                    control.innerHTML = `
                        <label title="${header}">${header}</label>
                        <select data-column="${header}">
                            <option value="">(å…¨éƒ¨)</option>
                            ${uniqueValues.map(v => `<option value="${escapeHtml(String(v))}">${escapeHtml(String(v))}</option>`).join('')}
                        </select>
                    `;
                    control.querySelector('select').addEventListener('change', updateView);
                    filterContainer.appendChild(control);
                });
            }

            window.resetFilters = function() {
                document.querySelectorAll('#filter-container select').forEach(sel => sel.value = "");
                tableSearchInput.value = "";
                updateView();
            }

            // --- æ›´æ–°è¦–åœ– ---
            function updateView() {
                let filteredData = [...originalData];

                // ç¯©é¸
                document.querySelectorAll('#filter-container select').forEach(select => {
                    if (select.value !== "") {
                        const column = select.dataset.column;
                        filteredData = filteredData.filter(row => String(row[column]) === select.value);
                    }
                });

                // æœå°‹
                const searchTerm = tableSearchInput.value.toLowerCase().trim();
                if (searchTerm) {
                    filteredData = filteredData.filter(row => 
                        Object.values(row).some(val => String(val).toLowerCase().includes(searchTerm))
                    );
                }

                currentViewData = filteredData;
                applySort();
                renderTable();
                updateExportButtons();
                dataStats.textContent = `é¡¯ç¤º ${currentViewData.length} / ${originalData.length} ç­†`;
            }

            tableSearchInput.addEventListener('input', updateView);

            // --- æ’åº ---
            function handleSort(column) {
                if (sortState.column === column) {
                    sortState.direction = sortState.direction === 'asc' ? 'desc' : 'asc';
                } else {
                    sortState.column = column;
                    sortState.direction = 'asc';
                }
                updateView();
            }

            function applySort() {
                const { column, direction } = sortState;
                if (!column) return;
                
                currentViewData.sort((a, b) => {
                    const valA = a[column] || "";
                    const valB = b[column] || "";
                    // å˜—è©¦æ•¸å€¼æ’åº
                    const numA = parseFloat(valA);
                    const numB = parseFloat(valB);
                    if (!isNaN(numA) && !isNaN(numB)) {
                        return direction === 'asc' ? numA - numB : numB - numA;
                    }
                    // å­—ä¸²æ’åº
                    return direction === 'asc' 
                        ? String(valA).localeCompare(String(valB)) 
                        : String(valB).localeCompare(String(valA));
                });
            }

            // --- æ¸²æŸ“è¡¨æ ¼ ---
            function renderTable() {
                tableContainer.innerHTML = '';
                if (currentViewData.length === 0) {
                    tableContainer.innerHTML = '<p style="text-align:center; padding:20px; color:#666;">ç„¡è³‡æ–™é¡¯ç¤ºã€‚</p>';
                    return;
                }

                const table = document.createElement('table');
                
                // è¡¨é ­
                const thead = table.createTHead();
                const headerRow = thead.insertRow();
                headers.forEach(header => {
                    const th = document.createElement('th');
                    th.className = 'sortable';
                    th.textContent = header;
                    if (sortState.column === header) th.classList.add(`sort-${sortState.direction}`);
                    th.addEventListener('click', () => handleSort(header));
                    headerRow.appendChild(th);
                });

                // å…§å®¹ (é™åˆ¶æ¸²æŸ“ 500 ç­†ä»¥å…å¡é “)
                const tbody = table.createTBody();
                const dataToRender = currentViewData.slice(0, 500); 

                dataToRender.forEach(rowObject => {
                    const row = tbody.insertRow();
                    headers.forEach(header => {
                        const cell = row.insertCell();
                        let val = rowObject[header];
                        cell.textContent = val != null ? val : "";
                    });
                });
                
                if (currentViewData.length > 500) {
                    const infoRow = tbody.insertRow();
                    const cell = infoRow.insertCell();
                    cell.colSpan = headers.length;
                    cell.style.textAlign = 'center';
                    cell.style.color = '#888';
                    cell.style.padding = '15px';
                    cell.textContent = `( âš ï¸ åƒ…é¡¯ç¤ºå‰ 500 ç­†é è¦½ï¼Œå®Œæ•´ ${currentViewData.length} ç­†è³‡æ–™è«‹ä½¿ç”¨åŒ¯å‡ºåŠŸèƒ½ä¸‹è¼‰ )`;
                }

                tableContainer.appendChild(table);
            }

            // --- åŒ¯å‡ºåŠŸèƒ½ ---
            function updateExportButtons() {
                const disabled = currentViewData.length === 0;
                Object.values(exportBtns).forEach(btn => btn.disabled = disabled);
            }

            // Excel
            exportBtns.excel.addEventListener('click', () => {
                const ws = XLSX.utils.json_to_sheet(currentViewData);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "API_Data");
                XLSX.writeFile(wb, `api_export_${getTodayStr()}.xlsx`);
            });

            // CSV
            exportBtns.csv.addEventListener('click', () => {
                const csvContent = [
                    headers.join(','), 
                    ...currentViewData.map(row => headers.map(header => {
                        let val = row[header] == null ? '' : String(row[header]);
                        if (val.includes(',') || val.includes('"') || val.includes('\n')) val = `"${val.replace(/"/g, '""')}"`;
                        return val;
                    }).join(','))
                ].join('\n');
                downloadFile(csvContent, `api_export_${getTodayStr()}.csv`, 'text/csv');
            });

            // JSON
            exportBtns.json.addEventListener('click', () => {
                downloadFile(JSON.stringify(currentViewData, null, 2), `api_export_${getTodayStr()}.json`, 'application/json');
            });

            // XML
            exportBtns.xml.addEventListener('click', () => {
                let xml = '<?xml version="1.0" encoding="UTF-8"?>\n<data>\n';
                currentViewData.forEach((row, i) => {
                    xml += `  <item id="${i+1}">\n`;
                    headers.forEach(h => {
                        const tag = h.replace(/[^a-zA-Z0-9_]/g, '_'); 
                        xml += `    <${tag}>${escapeHtml(String(row[h]||''))}</${tag}>\n`;
                    });
                    xml += `  </item>\n`;
                });
                xml += '</data>';
                downloadFile(xml, `api_export_${getTodayStr()}.xml`, 'application/xml');
            });

            // å·¥å…·å‡½å¼
            function showLoader(show) { show ? loader.classList.remove('hidden') : loader.classList.add('hidden'); }
            function showError(msg) { 
                if(!msg) { errorBox.classList.add('hidden'); return; }
                errorBox.innerHTML = msg; 
                errorBox.classList.remove('hidden'); 
            }
            function escapeHtml(text) { return text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;"); }
            function getTodayStr() { return new Date().toISOString().slice(0,10); }
            function downloadFile(content, fileName, mimeType) {
                const blob = new Blob([content], { type: mimeType + ';charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url; a.download = fileName; document.body.appendChild(a); a.click(); document.body.removeChild(a);
            }
        });
    </script>
</body>
</html>
